# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
name: Logo CI

permissions: read-all

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # === Language Enforcement ===
  language-check:
    name: Language Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Verify Logo-only in src/
        run: |
          echo "üö´ Checking for forbidden languages in src/..."
          forbidden=$(find src/ -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.rb" -o -name "*.go" -o -name "*.rs" \) 2>/dev/null || true)
          if [ -n "$forbidden" ]; then
            echo "ERROR: Found forbidden language files in src/:"
            echo "$forbidden"
            exit 1
          fi
          echo "‚úì Only Logo files in src/"

      - name: Verify Logo file exists
        run: |
          if [ ! -f src/terrapin-ssg.logo ]; then
            echo "ERROR: src/terrapin-ssg.logo not found"
            exit 1
          fi
          echo "‚úì Logo engine file exists"

      - name: Verify Logo syntax structure
        run: |
          if ! grep -q "^TO\|^to" src/terrapin-ssg.logo; then
            echo "ERROR: No procedure definitions found in Logo file"
            exit 1
          fi
          echo "‚úì Logo file has procedure definitions"

  # === Syntax Check ===
  syntax-check:
    name: Logo Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install UCBLogo
        run: |
          sudo apt-get update
          sudo apt-get install -y ucblogo || echo "UCBLogo not available in repos, checking manually"

      - name: Validate Logo structure
        run: |
          echo "üê¢ Validating Logo file structure..."

          # Check for required procedures
          for proc in build html_head svg_render; do
            if grep -qi "to $proc\|TO $proc" src/terrapin-ssg.logo; then
              echo "‚úì Found procedure: $proc"
            else
              echo "‚ö† Missing procedure: $proc"
            fi
          done

          # Check for balanced TO/END
          to_count=$(grep -ci "^to " src/terrapin-ssg.logo || echo 0)
          end_count=$(grep -ci "^end$" src/terrapin-ssg.logo || echo 0)
          echo "TO count: $to_count, END count: $end_count"

  # === Security Checks ===
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbwhat else do you have on your roadmap going forward?e5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for secrets
        run: |
          echo "üîí Checking for potential secrets..."
          if grep -rE "(password|secret|api.key|token)\s*=" src/ 2>/dev/null | grep -v "^Binary"; then
            echo "‚ö† Potential secrets found - review manually"
          else
            echo "‚úì No obvious secrets in src/"
          fi

      - name: Verify SHA-pinned actions
        run: |
          echo "üîê Checking SHA-pinned actions..."
          for workflow in .github/workflows/*.yml; do
            if grep -E "uses:.*@[a-f0-9]{40}" "$workflow" > /dev/null; then
              echo "‚úì $workflow uses SHA-pinned actions"
            else
              if grep -E "uses:.*@" "$workflow" > /dev/null; then
                echo "‚ö† $workflow may have non-SHA-pinned actions"
              fi
            fi
          done

      - name: Check adapter security
        run: |
          echo "üõ°Ô∏è Checking adapter security..."
          if [ -f adapters/src/TerrapinAdapter.res ]; then
            if grep -q "allowedPatterns" adapters/src/TerrapinAdapter.res; then
              echo "‚úì Pattern whitelist found in adapter"
            else
              echo "‚ö† No pattern whitelist in adapter"
            fi
          fi

  # === Build Test ===
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [language-check, syntax-check]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | sudo bash -s -- --to /usr/local/bin

      - name: Run validation
        run: just validate

      - name: Check project info
        run: just info

  # === Documentation Check ===
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Verify required docs
        run: |
          echo "üìö Checking required documentation..."
          docs=("README.adoc" "SECURITY.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md" ".claude/CLAUDE.md" "cookbook.adoc")
          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úì $doc exists"
            else
              echo "‚ö† $doc missing"
            fi
          done

      - name: Verify SCM files
        run: |
          echo "üìã Checking SCM files..."
          scm=("STATE.scm" "META.scm" "ECOSYSTEM.scm")
          for file in "${scm[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì $file exists"
            else
              echo "‚ö† $file missing"
            fi
          done

  # === Adapter Check ===
  adapter-check:
    name: Adapter Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: '20'

      - name: Check adapter dependencies
        run: |
          if [ -f adapters/package.json ]; then
            echo "üì¶ Checking adapter dependencies..."
            cd adapters
            npm install --ignore-scripts
            echo "‚úì Adapter dependencies installed"
          fi

      - name: Verify ReScript files
        run: |
          if [ -f adapters/src/TerrapinAdapter.res ]; then
            echo "‚úì ReScript adapter exists"
          else
            echo "‚ö† ReScript adapter missing"
          fi
